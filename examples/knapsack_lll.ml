(** Low-density attack for the knapsack cryptosystem
 * Attack described in
 * http://www.cs.sjsu.edu/faculty/stamp/papers/topics/topic16/Knapsack.pdf
 * Here we use an improvement to the attack:
 * “Improved low-density subset sum algorithms,” by M. J. Coster, A. Joux,
 * B. A. LaMacchia, A. M. Odlyzko, C. P. Schnorr, and J. Stern,
 * (Computational Complexity, Vol. 2, pp. 111 – 128, 1992).
 * The density is here 0.94 < 0.9408. *)

open Pari
open Signed

(* This line is mandatory to initialize the PARI stack;heap;table of primes... *)
let () = pari_init 500_000_000 (Unsigned.ULong.of_int 500_000)

(* Modulus *)
let n : Integer.t =
  Option.get
    (Integer.of_string "1792066535996536584496239542078920174708597170")

(* Public key *)
let k : (Integer.t, _) Vector.t =
  Vector.of_array
    (Array.map
       (fun s -> Option.get (Integer.of_string s))
       [|
         "664641536926699353270518217676803531307353479";
         "148710039882277198604102033114479066228425291";
         "630872474842190815872487844049847721182071941";
         "1615794992394179511907545659804088998795400500";
         "344126547784514142369584412934884954111557647";
         "677693127149650613521789266855136119045895060";
         "668406105718460809153197708330752703583717352";
         "1540759443046858617367602224196050268974518807";
         "613902651946707705126751846857900635656929925";
         "1227283014686821529317030769570037660665454641";
         "1500104742264401654066038910756286986402962604";
         "370885892449367464331936648502364365415614352";
         "1214070637048062715963510114453148410805528732";
         "775617580780072057314764291982591552349412575";
         "166366703174689687007072091427667839406522574";
         "945097390385784252134237529604733874882702666";
         "1417895928622240716968838241761048069791105304";
         "571600565500815022453957765376677488448781813";
         "917959866150739743099791963807621333186570652";
         "526886113275846320532518403381297164365532799";
         "76972327788310171877151570676089990602399631";
         "346635533158387830349499824344406239636789519";
         "575544546083839634498405727090549966378940837";
         "1784398916640641529239506277577844503632511257";
         "134767572388070770587896635167697352472000689";
         "945607132133208367224479253936438043175917106";
         "1676358871432706143546056858559855028268593069";
         "1292821875536078795293917089272678674309778252";
         "84780744047233404517824127529965246850572486";
         "1468035138700722303485334220279242206531533243";
         "1466722071660968809609175475903898834353002038";
         "1119561284877853851038721726171925101445092826";
         "1745007395158832731094416951338478130363571544";
         "1677176510286769455882150525332610914763042256";
         "338777191319578293212978304760953687524451127";
         "913181519507226599139302094100353604387647059";
         "1676086131512394356865083382648937310601653200";
         "1635244180779281549940687625994839395581529689";
         "759761771723053083842616207487337714414728738";
         "543071837487119619121662461652013497799728315";
         "624752984048685042785382947634083511901313642";
         "1613767786422149716326400143223351962312167330";
         "749359370277912231826968125897870233155006737";
         "1542003192646522910396400336145802844315704828";
         "1301977528509293026577467765081555692451627511";
         "426158573054118574843987339335896286231740532";
         "1763842173931176028137848505469360936484673194";
         "405116063197031043053317543832746210799763439";
         "198390431564251088923014665061857836178274569";
         "1749273030647031750567716580089644755919317400";
         "504264265281056185331027173686210151740910286";
         "1545231771640893947138914367200169939816252422";
         "1201964520293268586327912030134345973933178344";
         "632982441428755930594343636219039351512199986";
         "1630748990388885372880794444539027252182345227";
         "149489664531827403756588980986712631372327739";
         "524220593914545109321301528919158906455648452";
         "1520914136380615966254397516668658696435065335";
         "338236708941756469562681664460828854140341370";
         "396517250511556717796607911701621879639436163";
         "1223093479494930538023334404793128282544291418";
         "1147539211981407621284825202985023648708726162";
         "1447087303058340351736211574642202872009050001";
         "1552416503419726762280273099715031653182020377";
         "637739061899037875888566522041627014720338274";
         "1114467151474441278834075038134929138540346993";
         "167645664401965383372692317367457266457538876";
         "292355069517628240627235833148694562008323204";
         "1733603267748244975539267391492615752871267373";
         "290445637516696899271996389750717269291103403";
         "1224935164327931690316224803294734102183525026";
         "1236921003817817017794745961778754026251234071";
         "1272149036825757185217798403289112477761746007";
         "1653718886265132874108324456428002966307271949";
         "485423302869062417821311056853570066792242785";
         "1603982333808889135573159295721963500909646750";
         "1565652749916706647127126930771013114635932039";
         "1221338347201742723245262756482922338119160304";
         "296211922892755061207400716418688537999530014";
         "561092133331773029386978038557318115566336132";
         "134824399480785918368691282013498103826786063";
         "999042917622120899809439266846972102419994233";
         "818209186881912132930574696982501022651580411";
         "1067687034622513755107835414329508634338131464";
         "729037481216421819534139935328392017930583078";
         "1264861795644482271536610263518794166780770690";
         "1563831853749355665727030132729560191709032453";
         "5617712039984199168153722498908331896887166";
         "193192236840160253401966927593487929499075952";
         "1266055499842928411289511363558721651938214929";
         "74706541153829043563634401834034783662605597";
         "192871630800554494181890529400053148880370951";
         "1469013326569257971286250091942554545408952224";
         "1704305584266110157924352703808969741446584805";
         "403595307697637368514762220728305130068756459";
         "1397390084179736510841912821885213656555919550";
         "338072095436237083917067884014703607095888451";
         "150523207419664143511128231362054977682970495";
         "171367154969430907107021851055844024898335331";
         "182071530419623261895300978927205565995277913";
         "975636562864661600349907097694203310312871329";
         "1318659686865152781705749937519346863948986687";
         "93868300223474771847656305200924062321171614";
         "359307541189961687855750175364806804719893017";
         "675678823093620849593351549143393638533031486";
         "1694499527673265987507578228212704637221162550";
         "889354723136993511130249895083465597519619903";
         "136745721377311318865623412257859714954815151";
         "1368366054555337053744041264964328688031871276";
         "1083860222990224812251511310241109699703160857";
         "1674127560590168534456469043622610937528112815";
         "1663703329801754760024228190513772831163983233";
         "558366128441392506052173961480199945941234926";
         "344575975338131383226300059936125229758761600";
         "753382243203518595317665680869659212328186619";
         "475946070731380643175444840906196715795327280";
         "1477861317719967231298212501243588075198397773";
         "358949430629621434009210713430473928285487407";
         "331820720486916053579397495348810525509120688";
         "1757993763567952642235116507000466698492077141";
         "1734480959558746371191373030936647011452777346";
         "357475892078143281314219077927715760561597186";
         "886696821301496667101033362200311404750212564";
         "646665029141947944224975965526190980297055049";
         "1410708385712435994026230569886802066389811493";
         "536279639244648194446140944980839106841222126";
         "911200113361265995324908601249510915683177891";
         "931472846531754573698229569584957435051198911";
         "1252148576646885912085784564857807505977955931";
         "1033730272737910304624972675387581008399568593";
         "1208735359749770086886969319050762598664046226";
         "1248154039556588178303014360404715804316904631";
         "887068837887821428736236868235788717377855727";
         "1527080088477205371980960485968891398492404400";
         "671371882966818504716820125284495615209399789";
         "967051497178489905899838236689566484984697283";
         "1236562877356761722691916088984979646284101564";
         "1325799493620316593908455225212023495658797790";
         "1449035534419766535884428723246045398829531430";
         "430628931094721502472562486339812098916423574";
       |])

(* Ciphertext *)
let c : Integer.t =
  Option.get
    (Integer.of_string "1767340387062422074966517854316675617102166991")

let k1 : Integer.t = Vector.(k.%[1])
let l : long = Vector.length k

(* We consider the key without its first weight *)
let kred : (Integer.t, _) Vector.t =
  Vector.slice k ~start:(Long.of_int 2) ~stop:l

let b : Integer.t =
  Real.ceil (Integer.sqrt (Integer.shift (Integer.of_signed l) l))

(* Build lattice basis *)
let basis : Real.t Matrix.t =
  let basis = Matrix.(inj ~inj:Integer.inj_real (id l)) in
  let l = Long.to_int l in
  Matrix.(basis.%[l; l] <- Integer.(inj_real (mul c (neg b))));
  for i = 1 to l - 1 do
    Matrix.(basis.%[l; i] <- Integer.(inj_real (mul b Vector.(kred.%[i]))));
    (* We translate the lattice to favor short vectors with coefficients
       in {0;1} instead of in {-1;0;1}. *)
    Matrix.(basis.%[i; l] <- Real.(inv Integer.(inj_real (neg (of_int 2)))))
  done;
  basis

(* Check if col is a solution to the given knapsack instance: col * k^T = c. *)
let check_knapsack_equation col =
  Integer.Infix.(
    Real.ceil
      Vector.(
        mul (transpose_column col) (inj (transpose_row k) ~inj:Integer.inj_real))
    mod n
    = c)

(* shift vector v by constant 1/2 *)
let shift_vec_inplace (v : (Real.t, _) Vector.t) : unit =
  let open Vector in
  for i = 1 to Long.to_int (length v) do
    v.%[i] <- Real.add (Real.inv (Integer.inj_real (Integer.of_int 2))) v.%[i]
  done

(* A candidate should be made of two repeated elements: 0 and a constant
   (here it's luckily 1). *)
let check_column (col : (Real.t, _) Vector.t) : bool =
  let s = Vector.to_set col in
  Long.(equal (Set.length s) (of_int 2))
  && Long.(Set.search s Integer.(inj_real (of_int 0)) zero = one)

let search_sol () =
  let l = Long.to_int l in
  let rec search_sol_aux i =
    match
      let aux ~bit =
        (* Subtract the first weight from the ciphertext since we didn't include it
           in the basis. *)
        Matrix.(
          basis.%[l; l] <-
            Integer.(inj_real Infix.((c - (k1 * bit) + (n * of_int i)) * ~-b)));
        let reduced_basis = Matrix.(mul basis (lll basis)) in
        (* Pick elements from the reduced basis and check if they are solutions
           to the knapsack problem. *)
        let rec loop ~bit j =
          if j = l then None
          else
            let col =
              Vector.(
                slice
                  Matrix.(reduced_basis.%[j])
                  ~start:Long.one
                  ~stop:Long.(sub (of_int l) one))
            in
            shift_vec_inplace col;
            let candidate =
              Vector.(concat (singleton (Integer.inj_real bit)) col)
            in
            if check_column col && check_knapsack_equation candidate then
              Some candidate
            else loop ~bit (j + 1)
        in
        loop ~bit 1
      in
      (aux ~bit:(Integer.of_int 0), aux ~bit:(Integer.of_int 1))
    with
    | None, None -> search_sol_aux (i + 1)
    | Some w, _ | _, Some w -> w
  in
  search_sol_aux 1

let () =
  Printf.eprintf "%s\n" Vector.(to_string (transpose_column (search_sol ())))
